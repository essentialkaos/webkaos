From 99efd37675ada20ab532f43629d846e136747dce Mon Sep 17 00:00:00 2001
From: Andrei Belov <defanator@gmail.com>
Date: Wed, 22 Mar 2017 07:50:57 +0300
Subject: [PATCH 1/3] fixed build with nginx/1.11.11

Closes openresty/lua-nginx-module#1016

See also:
http://hg.nginx.org/nginx/rev/e662cbf1b932
---
 src/ngx_http_lua_headers.c | 15 +++++++++++----
 1 file changed, 11 insertions(+), 4 deletions(-)

diff --git a/src/ngx_http_lua_headers.c b/src/ngx_http_lua_headers.c
index a7cfc3c..78ca408 100644
--- a/src/ngx_http_lua_headers.c
+++ b/src/ngx_http_lua_headers.c
@@ -77,6 +77,7 @@ ngx_http_lua_ngx_req_raw_header(lua_State *L)
     size_t                       size;
     ngx_buf_t                   *b, *first = NULL;
     ngx_int_t                    i, j;
+    ngx_chain_t                 *cl, *ln;
     ngx_connection_t            *c;
     ngx_http_request_t          *r, *mr;
     ngx_http_connection_t       *hc;
@@ -147,8 +148,11 @@ ngx_http_lua_ngx_req_raw_header(lua_State *L)
 
     if (hc->nbusy) {
         b = NULL;
-        for (i = 0; i < hc->nbusy; i++) {
-            b = hc->busy[i];
+        for (cl = hc->busy; cl; /* void */) {
+            ln = cl;
+            cl = cl->next;
+
+            b = ln->buf;
 
             dd("busy buf: %d: [%.*s]", (int) i, (int) (b->pos - b->start),
                b->start);
@@ -223,8 +227,11 @@ ngx_http_lua_ngx_req_raw_header(lua_State *L)
     }
 
     if (hc->nbusy) {
-        for (i = 0; i < hc->nbusy; i++) {
-            b = hc->busy[i];
+        for (cl = hc->busy; cl; /* void */) {
+            ln = cl;
+            cl = cl->next;
+
+            b = ln->buf;
 
             if (!found) {
                 if (b != first) {

From 93f8e82f1bf7dcfe84ca8e05b9ca45d4d5282327 Mon Sep 17 00:00:00 2001
From: Andrei Belov <defanator@gmail.com>
Date: Wed, 22 Mar 2017 08:19:35 +0300
Subject: [PATCH 2/3] fixed build with nginx < 1.11.11

---
 src/ngx_http_lua_headers.c | 24 +++++++++++++++++-------
 1 file changed, 17 insertions(+), 7 deletions(-)

diff --git a/src/ngx_http_lua_headers.c b/src/ngx_http_lua_headers.c
index 78ca408..43ea87a 100644
--- a/src/ngx_http_lua_headers.c
+++ b/src/ngx_http_lua_headers.c
@@ -77,7 +77,9 @@ ngx_http_lua_ngx_req_raw_header(lua_State *L)
     size_t                       size;
     ngx_buf_t                   *b, *first = NULL;
     ngx_int_t                    i, j;
-    ngx_chain_t                 *cl, *ln;
+#if defined(nginx_version) && nginx_version >= 1011011
+    ngx_chain_t                 *cl;
+#endif
     ngx_connection_t            *c;
     ngx_http_request_t          *r, *mr;
     ngx_http_connection_t       *hc;
@@ -148,11 +150,15 @@ ngx_http_lua_ngx_req_raw_header(lua_State *L)
 
     if (hc->nbusy) {
         b = NULL;
+
+#if defined(nginx_version) && nginx_version >= 1011011
         for (cl = hc->busy; cl; /* void */) {
-            ln = cl;
+            b = cl->buf;
             cl = cl->next;
-
-            b = ln->buf;
+#else
+        for (i = 0; i < hc->nbusy; i++) {
+            b = hc->busy[i];
+#endif
 
             dd("busy buf: %d: [%.*s]", (int) i, (int) (b->pos - b->start),
                b->start);
@@ -227,11 +233,15 @@ ngx_http_lua_ngx_req_raw_header(lua_State *L)
     }
 
     if (hc->nbusy) {
+
+#if defined(nginx_version) && nginx_version >= 1011011
         for (cl = hc->busy; cl; /* void */) {
-            ln = cl;
+            b = cl->buf;
             cl = cl->next;
-
-            b = ln->buf;
+#else
+        for (i = 0; i < hc->nbusy; i++) {
+            b = hc->busy[i];
+#endif
 
             if (!found) {
                 if (b != first) {

From 02d58814491a9a9edb033dcaf00596b52eb69b89 Mon Sep 17 00:00:00 2001
From: Andrei Belov <defanator@gmail.com>
Date: Wed, 22 Mar 2017 08:20:40 +0300
Subject: [PATCH 3/3] travis-ci: bump mainline nginx version to 1.11.11

---
 .travis.yml | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/.travis.yml b/.travis.yml
index eb0748c..022f259 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -50,7 +50,7 @@ env:
     - TEST_NGINX_SLEEP=0.006
   matrix:
     - NGINX_VERSION=1.9.15
-    - NGINX_VERSION=1.11.2
+    - NGINX_VERSION=1.11.11
 
 services:
  - memcache
